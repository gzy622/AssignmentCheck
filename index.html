<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>作业极速登记</title>
    <link href="css/tailwind.min.css" rel="stylesheet">
    <link href="css/all.min.css" rel="stylesheet">
    <style>
        /* 基础设置 */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            touch-action: pan-y;
            overflow: hidden;
        }

        @supports (-webkit-touch-callout: none) {
            body {
                height: -webkit-fill-available;
            }
        }

        /* 交互反馈 */
        .student-btn {
            -webkit-touch-callout: none;
            /* 禁止iOS长按弹出菜单 */
        }

        .student-btn:active {
            transform: scale(0.95);
        }

        .task-item {
            transition: background-color 0.2s;
        }

        .task-item:active {
            background-color: #f3f4f6;
        }

        .immersive-toggle-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .menu-item:active {
            background-color: #f3f4f6;
        }

        .touch-feedback:active {
            background-color: #f8fafc;
            transform: scale(0.98);
        }

        /* 状态样式 */
        .status-default {
            background-color: #ffffff;
            color: #374151;
            border: 1px solid #e5e7eb;
        }

        .status-submitted {
            background-color: #10b981;
            color: white;
            border: 1px solid #059669;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        /* 隐藏滚动条 */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 模态框层级管理 */
        .z-modal-backdrop {
            z-index: 50;
        }

        .z-modal-content {
            z-index: 51;
        }

        .z-toast {
            z-index: 70;
        }

        .z-input-modal {
            z-index: 60;
        }
    </style>
</head>
<!-- [修改] body 增加桌面端背景色和居中布局 -->

<body class="h-screen w-screen overflow-hidden text-gray-800">

    <!-- [新增] 手机模拟容器 -->
    <!-- 移动端：w-full h-full (全屏) -->
    <!-- 桌面端：h-[90vh] aspect-[9/16] (90%屏幕高度，锁定9:16比例) -->
    <div id="app-container"
        class="relative w-full h-full flex flex-col">

        <!-- 顶部导航 -->
        <header id="app-header"
            class="bg-white shadow-sm z-10 px-4 py-2 flex justify-between items-center shrink-0 transition-all duration-300 h-12">
            <div onclick="openTaskModal()"
                class="flex items-center gap-2 cursor-pointer active:opacity-60 transition-opacity">
                <h1 id="current-task-title" class="text-base font-bold text-gray-800 truncate max-w-[160px]">作业</h1>
                <i class="fa-solid fa-caret-down text-gray-400 text-xs pb-0.5"></i>
            </div>
            <div class="flex items-baseline gap-1">
                <span class="text-xs text-gray-500">已交</span>
                <span class="text-xl font-bold text-blue-600 font-mono" id="count-display">0/49</span>
            </div>
        </header>

        <!-- 进度条 -->
        <div id="app-progress" class="w-full h-1 bg-gray-200 shrink-0 transition-all duration-300">
            <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
        </div>

        <!-- 主体网格 -->
        <main id="main-container" class="flex-1 overflow-y-auto hide-scrollbar p-3 transition-all duration-300">
            <div id="student-grid" class="grid grid-cols-5 gap-3 pb-24 transition-opacity duration-200 opacity-0"></div>
        </main>

        <!-- 悬浮按钮 (fixed 改为 absolute 以限制在容器内) -->
        <button onclick="toggleFooterOnly()" id="immersive-btn"
            class="immersive-toggle-btn absolute right-4 bottom-28 z-30 w-10 h-10 bg-white/90 backdrop-blur text-gray-500 rounded-full shadow-lg border border-gray-200 flex items-center justify-center active:scale-90 hover:text-blue-600">
            <i class="fa-solid fa-expand text-base"></i>
        </button>

        <!-- 底部操作栏 -->
        <footer id="app-footer"
            class="bg-white border-t border-gray-200 p-3 pb-6 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20 transition-all duration-300">
            <div class="flex gap-2 h-12">
                <button onclick="toggleClickMode()" id="btn-mode-toggle"
                    class="w-14 bg-white text-gray-600 border border-gray-300 rounded-xl font-medium active:bg-gray-50 flex flex-col items-center justify-center text-[10px] shadow-sm transition-colors duration-200">
                    <i class="fa-solid fa-list-check text-sm mb-0.5"></i> <span id="mode-text">登记</span>
                </button>

                <button onclick="toggleNameDisplay()" id="btn-toggle-name"
                    class="w-14 bg-white text-gray-600 border border-gray-300 rounded-xl font-medium active:bg-gray-50 flex flex-col items-center justify-center text-[10px] shadow-sm">
                    <i class="fa-solid fa-user-tag text-sm mb-0.5"></i> 姓名
                </button>

                <button onclick="exportData()"
                    class="flex-1 bg-gray-800 text-white font-medium rounded-xl active:bg-gray-900 shadow transition flex items-center justify-center text-sm"
                    title="导出数据">
                    <i class="fa-solid fa-file-export text-lg"></i>
                </button>

                <button onclick="openStatsModal()"
                    class="w-12 bg-white text-gray-600 border border-gray-300 rounded-xl font-medium active:bg-gray-50 flex flex-col items-center justify-center shadow-sm text-[10px]">
                    <i class="fa-solid fa-chart-bar text-sm mb-0.5"></i> 统计
                </button>

                <button onclick="openDataModal()"
                    class="w-12 bg-white text-gray-600 border border-gray-300 rounded-xl font-medium active:bg-gray-50 flex flex-col items-center justify-center shadow-sm text-[10px]">
                    <i class="fa-solid fa-database text-sm mb-0.5"></i> 数据
                </button>
            </div>
        </footer>

        <!-- 全局提示 (fixed 改为 absolute) -->
        <div id="toast"
            class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-4 py-2 rounded-lg text-sm opacity-0 pointer-events-none transition-opacity duration-300 z-toast text-center whitespace-nowrap">
        </div>

        <!-- ================= 模态框区域 (fixed 改为 absolute) ================= -->

        <!-- 1. 评分弹窗 -->
        <div id="score-modal-backdrop"
            class="absolute inset-0 bg-black/40 backdrop-blur-sm hidden z-modal-backdrop flex items-center justify-center p-4">
            <div id="score-modal"
                class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl transform transition-all scale-95 opacity-0 z-modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">学号 <span id="modal-student-id"
                            class="text-blue-600">01</span> <span id="modal-student-name"
                            class="text-sm font-normal text-gray-500 ml-2"></span></h3>
                    <button onclick="closeModal('score-modal')" class="text-gray-400 hover:text-gray-600 p-2"><i
                            class="fa-solid fa-times"></i></button>
                </div>
                <div class="grid grid-cols-4 gap-2 mb-4">
                    <button onclick="setScoreAndClose('A')"
                        class="btn-score py-2 rounded-lg bg-blue-50 text-blue-600 font-bold border border-blue-100 active:bg-blue-100">A</button>
                    <button onclick="setScoreAndClose('B')"
                        class="btn-score py-2 rounded-lg bg-blue-50 text-blue-600 font-bold border border-blue-100 active:bg-blue-100">B</button>
                    <button onclick="setScoreAndClose('C')"
                        class="btn-score py-2 rounded-lg bg-blue-50 text-blue-600 font-bold border border-blue-100 active:bg-blue-100">C</button>
                    <button onclick="setScoreAndClose('D')"
                        class="btn-score py-2 rounded-lg bg-blue-50 text-blue-600 font-bold border border-blue-100 active:bg-blue-100">D</button>
                </div>
                <div class="relative mb-4">
                    <input type="number" id="custom-score-input" placeholder="输入分数" inputmode="decimal" step="any"
                        enterkeyhint="done"
                        class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white text-center">
                </div>
                <div class="flex gap-2">
                    <button onclick="setScoreAndClose(null)"
                        class="flex-1 py-3 rounded-xl bg-red-50 text-red-500 font-medium active:bg-red-100">清除</button>
                    <button onclick="saveCustomScore()"
                        class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-medium active:bg-blue-700">确定</button>
                </div>
            </div>
        </div>

        <!-- 2. 任务列表弹窗 (fixed 改为 absolute) -->
        <div id="task-modal-backdrop"
            class="absolute inset-0 bg-black/40 backdrop-blur-sm hidden z-modal-backdrop flex items-end sm:items-center justify-center sm:p-4">
            <div id="task-modal"
                class="bg-white w-full sm:max-w-sm sm:rounded-2xl rounded-t-2xl p-0 shadow-2xl transform transition-transform duration-300 translate-y-full flex flex-col max-h-[85vh] z-modal-content">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center shrink-0">
                    <h3 class="text-lg font-bold text-gray-800">作业列表</h3>
                    <button onclick="closeModal('task-modal')" class="text-gray-400 hover:text-gray-600 p-2"><i
                            class="fa-solid fa-times"></i></button>
                </div>
                <div id="task-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
                <div class="p-4 border-t border-gray-100 shrink-0">
                    <button onclick="triggerCreateTask()"
                        class="w-full py-3 rounded-xl bg-blue-600 text-white font-medium active:bg-blue-700 shadow-sm flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i> 新建作业
                    </button>
                </div>
            </div>
        </div>

        <!-- 3. 数据管理弹窗 (fixed 改为 absolute) -->
        <div id="data-modal-backdrop"
            class="absolute inset-0 bg-black/40 backdrop-blur-sm hidden z-modal-backdrop flex items-end sm:items-center justify-center sm:p-4">
            <div id="data-modal"
                class="bg-white w-full sm:max-w-sm sm:rounded-2xl rounded-t-2xl p-0 shadow-2xl transform transition-transform duration-300 translate-y-full flex flex-col z-modal-content">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center shrink-0">
                    <h3 class="text-lg font-bold text-gray-800">数据管理</h3>
                    <button onclick="closeModal('data-modal')" class="text-gray-400 hover:text-gray-600 p-2"><i
                            class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-4 space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="exportData()"
                            class="flex flex-col items-center justify-center p-4 bg-blue-50 border border-blue-100 rounded-xl active:bg-blue-100 transition">
                            <i class="fa-solid fa-file-export text-blue-600 text-2xl mb-2"></i>
                            <span class="text-sm font-bold text-gray-700">导出备份</span>
                            <span class="text-[10px] text-gray-400 mt-1">保存为 JSON</span>
                        </button>
                        <button onclick="triggerImport()"
                            class="flex flex-col items-center justify-center p-4 bg-green-50 border border-green-100 rounded-xl active:bg-green-100 transition">
                            <i class="fa-solid fa-file-import text-green-600 text-2xl mb-2"></i>
                            <span class="text-sm font-bold text-gray-700">导入恢复</span>
                            <span class="text-[10px] text-gray-400 mt-1">读取 JSON</span>
                        </button>
                    </div>

                    <div class="pt-2 border-t border-gray-100">
                        <h4 class="text-xs font-bold text-gray-400 uppercase mb-2 ml-1">操作</h4>
                        <button onclick="copyMissingReport(); closeModal('data-modal')"
                            class="w-full p-3 rounded-xl bg-gray-50 text-gray-700 font-medium active:bg-gray-100 flex items-center justify-between mb-2 menu-item">
                            <span><i class="fa-regular fa-copy text-gray-500 mr-2"></i> 复制未交名单</span>
                            <i class="fa-solid fa-chevron-right text-xs text-gray-300"></i>
                        </button>
                        <button onclick="invertSelection(); closeModal('data-modal')"
                            class="w-full p-3 rounded-xl bg-gray-50 text-gray-700 font-medium active:bg-gray-100 flex items-center justify-between mb-2 menu-item">
                            <span><i class="fa-solid fa-right-left text-gray-500 mr-2"></i> 一键反选状态</span>
                        </button>

                        <h4 class="text-xs font-bold text-gray-400 uppercase mb-2 ml-1 mt-4">危险区域</h4>
                        <button onclick="openResetModal('current')"
                            class="w-full p-3 rounded-xl bg-gray-50 text-gray-700 font-medium active:bg-gray-100 flex items-center justify-between mb-2 menu-item">
                            <span><i class="fa-solid fa-eraser text-orange-400 mr-2"></i> 清空当前作业</span>
                            <i class="fa-solid fa-chevron-right text-xs text-gray-300"></i>
                        </button>
                        <button onclick="openResetModal('all')"
                            class="w-full p-3 rounded-xl bg-red-50 text-red-500 font-medium active:bg-red-100 flex items-center justify-between menu-item">
                            <span><i class="fa-solid fa-trash-can mr-2"></i> 重置所有数据</span>
                            <i class="fa-solid fa-chevron-right text-xs text-red-200"></i>
                        </button>
                    </div>

                    <!-- 版本号显示 -->
                    <div class="pt-3 mt-2 border-t border-gray-100 text-center">
                        <span class="text-[10px] text-gray-400">版本 v<span id="data-modal-version">1.1.2</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. 通用输入弹窗 (fixed 改为 absolute) -->
        <div id="input-modal-backdrop"
            class="absolute inset-0 bg-black/50 backdrop-blur-sm hidden z-input-modal flex items-center justify-center p-4">
            <div id="input-modal"
                class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl transform transition-all scale-95 opacity-0">
                <h3 id="input-modal-title" class="text-xl font-bold text-gray-800 mb-4">标题</h3>
                <input type="text" id="common-input"
                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-lg mb-6 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center"
                    placeholder="">
                <div class="flex gap-3">
                    <button onclick="closeModal('input-modal')"
                        class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-700 font-medium active:bg-gray-200">取消</button>
                    <button id="input-confirm-btn"
                        class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-medium active:bg-blue-700 shadow-sm">确定</button>
                </div>
            </div>
        </div>

        <!-- 5. 通用确认弹窗 (fixed 改为 absolute) -->
        <div id="confirm-modal-backdrop"
            class="absolute inset-0 bg-black/50 backdrop-blur-sm hidden z-input-modal flex items-center justify-center p-4">
            <div id="confirm-modal"
                class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl transform transition-all scale-95 opacity-0">
                <h3 id="confirm-title" class="text-xl font-bold text-gray-800 mb-2">确认操作</h3>
                <p id="confirm-msg" class="text-gray-600 mb-6 text-sm leading-relaxed"></p>
                <div class="flex gap-3">
                    <button onclick="closeModal('confirm-modal')"
                        class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-700 font-medium active:bg-gray-200">取消</button>
                    <button id="confirm-action-btn"
                        class="flex-1 py-3 rounded-xl bg-red-500 text-white font-medium active:bg-red-600 shadow-sm">确定</button>
                </div>
            </div>
        </div>

        <!-- 6. 统计汇总全屏页面 -->
        <div id="stats-modal-backdrop"
            class="fixed inset-0 bg-white z-modal-backdrop hidden flex flex-col">
            <div id="stats-modal" class="flex flex-col h-full">
                <div id="stats-modal-header"
                    class="px-4 py-1.5 border-b border-gray-100 flex justify-between items-center shrink-0 bg-white sticky top-0 z-10 transition-all duration-300">
                    <div class="flex items-center gap-2">
                        <h3 class="text-sm font-bold text-gray-900">提交情况统计</h3>
                        <p class="text-xs text-gray-500" id="stats-subtitle">选择作业查看提交情况</p>
                    </div>
                    <button onclick="closeModal('stats-modal')"
                        class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition-colors"><i
                            class="fa-solid fa-times text-sm"></i></button>
                </div>

                <div class="flex-1 overflow-hidden flex flex-col">
                    <div id="stats-selection-area" class="flex-[10] overflow-y-auto hide-scrollbar transition-all duration-300">
                        <div class="p-4 border-b border-gray-100 bg-white">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-list-check text-gray-400 text-sm"></i>
                                    <span class="text-sm font-semibold text-gray-700">选择作业</span>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="selectAllTasksForStats()"
                                        class="text-xs px-2 py-1 text-blue-600 hover:bg-blue-50 rounded transition">全选</button>
                                    <button onclick="clearTaskSelectionForStats()"
                                        class="text-xs px-2 py-1 text-gray-500 hover:bg-gray-100 rounded transition">清空</button>
                                </div>
                            </div>
                            <div id="stats-task-list" class="space-y-2"></div>
                        </div>

                        <div class="p-4 border-b border-gray-100 bg-gray-50/50">
                            <div class="flex gap-2 overflow-x-auto hide-scrollbar py-1">
                                <button onclick="quickFilterStats('all')"
                                    class="whitespace-nowrap px-4 py-2 bg-white border border-gray-200 rounded-full text-xs font-medium text-gray-600 hover:bg-gray-50 transition-colors">
                                    全部作业
                                </button>
                                <button onclick="quickFilterStats('recent')"
                                    class="whitespace-nowrap px-4 py-2 bg-white border border-gray-200 rounded-full text-xs font-medium text-gray-600 hover:bg-gray-50 transition-colors">
                                    最近5次
                                </button>
                                <button onclick="quickFilterStats('latest')"
                                    class="whitespace-nowrap px-4 py-2 bg-white border border-gray-200 rounded-full text-xs font-medium text-gray-600 hover:bg-gray-50 transition-colors">
                                    最新作业
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="stats-selected-tasks-bar" class="hidden px-3 py-1.5 border-b border-gray-100 bg-blue-50/50 shrink-0">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-medium text-blue-700">已选：</span>
                            <div id="stats-selected-tasks-list" class="flex-1 flex flex-wrap gap-1 max-h-10 overflow-y-auto hide-scrollbar"></div>
                            <button onclick="expandStatsSelection()"
                                class="text-xs text-blue-600 hover:text-blue-800 transition">修改</button>
                        </div>
                    </div>

                    <div id="stats-container" class="hidden flex-[10] overflow-y-auto hide-scrollbar bg-gray-50/30 relative">
                        <button onclick="toggleStatsImmersive()" id="stats-immersive-btn"
                            class="immersive-toggle-btn absolute right-4 top-2 z-30 w-8 h-8 bg-white/90 backdrop-blur text-gray-500 rounded-full shadow-lg border border-gray-200 flex items-center justify-center active:scale-90 hover:text-blue-600 transition-all duration-300">
                            <i class="fa-solid fa-compress text-xs"></i>
                        </button>
                        <div class="p-4 space-y-4 max-w-3xl mx-auto">
                            <div id="stats-dashboard"></div>

                            <div class="flex flex-col sm:flex-row gap-2 items-center">
                                <div class="relative w-full sm:flex-1">
                                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                                    <input type="text" id="stats-search" oninput="debouncedFilterStatsList()"
                                        placeholder="搜索学生姓名或学号..."
                                        class="w-full pl-9 pr-3 py-2.5 bg-white border border-gray-200 rounded-xl text-sm focus:border-blue-500 focus:outline-none transition-all shadow-sm">
                                </div>
                                <button id="expand-all-btn"
                                    class="py-2.5 px-3 bg-white border border-gray-200 rounded-xl text-xs font-semibold text-gray-600 focus:outline-none focus:border-blue-500 transition-all shadow-sm flex items-center justify-center gap-1"
                                    onclick="toggleExpandAll()">
                                    <i class="fa-solid fa-expand text-xs"></i>
                                    <span id="expand-btn-text">展开详情</span>
                                </button>
                                <select id="stats-sort" onchange="sortStatsList()"
                                    class="w-full sm:w-36 py-2.5 px-3 bg-white border border-gray-200 rounded-xl text-xs font-semibold text-gray-600 focus:outline-none focus:border-blue-500 transition-all shadow-sm">
                                    <option value="id-asc">学号 1-49</option>
                                    <option value="rate-desc">提交率 ↓</option>
                                    <option value="rate-asc">提交率 ↑</option>
                                </select>
                            </div>

                            <div id="stats-list" class="space-y-3 pb-4"></div>
                        </div>
                    </div>

                    <div id="stats-empty" class="hidden flex-1 flex items-center justify-center">
                        <div class="text-center">
                            <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fa-solid fa-chart-simple text-3xl text-blue-400"></i>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-1">选择作业查看统计</h4>
                            <p class="text-sm text-gray-500">点击上方作业卡片开始生成统计报告</p>
                        </div>
                    </div>
                </div>

                <div id="stats-modal-footer" class="flex items-center gap-2 p-2 border-t border-gray-100 bg-white shrink-0 transition-all duration-300">
                    <span id="stats-selection-count" class="text-xs text-gray-400 whitespace-nowrap">已选 0/0</span>
                    <div class="flex-1 flex gap-1.5">
                        <button onclick="generateStats()"
                            class="flex-1 py-1.5 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-xs font-semibold active:scale-[0.98] transition-all shadow-lg shadow-blue-500/25 flex items-center justify-center gap-1">
                            <i class="fa-solid fa-chart-bar text-xs"></i>
                            生成统计
                        </button>
                        <button onclick="copyStatsReport()"
                            class="flex-1 py-1.5 rounded-xl bg-white border border-gray-200 text-gray-700 text-xs font-medium active:scale-[0.98] transition-all flex items-center justify-center gap-1">
                            <i class="fa-solid fa-copy text-xs"></i>
                            复制报告
                        </button>
                    </div>
                </div>
            </div>
        </div>


    </div> <!-- End app-container -->

    <input type="file" id="import-file-input" accept=".json" class="hidden" onchange="handleFileImport(event)">

    <script>
        // ================= 配置区域 =================
        // 版本号规则：主版本.次版本.修订号
        // - 主版本：重大功能更新或架构变更
        // - 次版本：新功能或重要改进
        // - 修订号：bug修复或小改进
        // 每次代码修改后更新版本号
        const APP_VERSION = '1.1.2';

        const TOTAL_STUDENTS = 49;
        const STORAGE_KEY_V2 = 'homework_data_v2';
        const STORAGE_KEY_V1 = 'homework_data_v1';
        const NAME_VISIBILITY_KEY = 'homework_name_visible';
        
        const UI_CONSTANTS = {
            TOAST_DURATION: 2000,
            LONG_PRESS_DURATION: 500,
            SAVE_THROTTLE_DELAY: 500,
            MODAL_TRANSITION_DELAY: 200,
            KEYBOARD_MAX_SHIFT_RATIO: 0.4
        };

        const PLACEHOLDER_NAMES = [
            "陈嘉乐", "廖婷", "徐伟浩", "刘嘉宝", "谢瑞宏", "练嘉铖", "崔鑫琪",
            "李梓龙", "古宏民", "刘秋娴", "刘银欣", "李嘉君", "周嘉琪", "曾婧玮",
            "丘欣芷", "吴玟怡", "杨欢", "吴学文", "罗雅茹", "凌浩天", "李佳",
            "刘卓莹", "彭嘉红", "谢瑞琳", "廖沁怡", "陈秉烨", "丘瑜诗", "郭银柳",
            "李欣", "周岷雍", "赖梅洁", "陈祖娴", "黄楚铭", "谢超宇", "熊飞凤",
            "吴嘉钰", "刘依婷", "吴苑婷", "曾誉宸", "刁瑜", "郭静", "刘诗琪",
            "黎伟平", "李敏锐", "杨鸿为", "熊晓逸", "梁黛秦", "谢蕊怡", "王杭州"
        ];

        // ================= 状态管理 =================
        let appState = { currentTaskId: null, tasks: [] };
        let currentStudents = [];
        let currentEditingId = null;
        let isFooterHidden = false;
        let isNameVisible = false;
        let isGradingMode = false; // [新增] 评分模式状态
        let modalStack = []; // 弹窗状态栈，用于管理返回键

        let onInputConfirm = null;
        let onActionConfirm = null;

        // ================= 性能优化工具 =================
        // 防抖：延迟执行，输入停止后才触发
        function debounce(fn, delay) {
            let timer = null;
            return function (...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // 节流：限制执行频率
        function throttle(fn, limit) {
            let lastCall = 0;
            let pendingArgs = null;
            let timer = null;
            return function (...args) {
                const now = Date.now();
                if (now - lastCall >= limit) {
                    lastCall = now;
                    fn.apply(this, args);
                } else {
                    pendingArgs = args;
                    if (!timer) {
                        timer = setTimeout(() => {
                            lastCall = Date.now();
                            fn.apply(this, pendingArgs);
                            timer = null;
                            pendingArgs = null;
                        }, limit - (now - lastCall));
                    }
                }
            };
        }

        // 数据类型检查工具
        const TypeValidator = {
            isNumber: (val) => typeof val === 'number' && !isNaN(val),
            isString: (val) => typeof val === 'string',
            isBoolean: (val) => typeof val === 'boolean',
            isArray: (val) => Array.isArray(val),
            isObject: (val) => val !== null && typeof val === 'object' && !Array.isArray(val),
            isValidId: (val) => TypeValidator.isNumber(val) && val > 0 && val <= TOTAL_STUDENTS,
            validateAppState: (state) => {
                if (!state || typeof state !== 'object') return false;
                if (!TypeValidator.isArray(state.tasks)) return false;
                if (!TypeValidator.isNumber(state.currentTaskId)) return false;
                return true;
            },
            validateTask: (task) => {
                if (!task || typeof task !== 'object') return false;
                if (!TypeValidator.isNumber(task.id)) return false;
                if (!TypeValidator.isString(task.title)) return false;
                if (!TypeValidator.isObject(task.records)) return false;
                return true;
            }
        };

        // 本地存储工具（带错误处理）
        const StorageHelper = {
            get: (key, defaultValue = null) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (e) {
                    console.error('Storage get error:', e);
                    return defaultValue;
                }
            },
            set: (key, value) => {
                try {
                    const str = JSON.stringify(value);
                    localStorage.setItem(key, str);
                    return true;
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        console.error('Storage quota exceeded');
                        showToast('存储空间不足');
                    } else {
                        console.error('Storage set error:', e);
                    }
                    return false;
                }
            },
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    console.error('Storage remove error:', e);
                    return false;
                }
            },
            clear: () => {
                try {
                    localStorage.clear();
                    return true;
                } catch (e) {
                    console.error('Storage clear error:', e);
                    return false;
                }
            }
        };

        // DOM 缓存（init时填充）
        const domCache = {};

        function isScoreModalOpen() {
            const backdrop = document.getElementById('score-modal-backdrop');
            return backdrop && !backdrop.classList.contains('hidden');
        }

        function getKeyboardHeight() {
            if (window.visualViewport) {
                const vv = window.visualViewport;
                return Math.max(0, window.innerHeight - vv.height - vv.offsetTop);
            }
            return Math.max(0, window.innerHeight - document.documentElement.clientHeight);
        }

        function updateScoreModalForKeyboard() {
            if (!isScoreModalOpen()) return;
            const modal = document.getElementById('score-modal');
            const keyboardHeight = getKeyboardHeight();
            const maxShift = Math.min(keyboardHeight, Math.round(window.innerHeight * UI_CONSTANTS.KEYBOARD_MAX_SHIFT_RATIO));
            modal.style.marginBottom = maxShift ? `${maxShift}px` : '';
        }


        // ================= 初始化 =================
        function init() {
            const savedVisibility = localStorage.getItem(NAME_VISIBILITY_KEY);
            if (savedVisibility !== null) isNameVisible = JSON.parse(savedVisibility);
            updateNameButtonState();

            loadData();
            renderGrid();
            updateStats();
            updateHeaderTitle();

            const scoreInput = document.getElementById('custom-score-input');
            scoreInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); saveCustomScore(); }
            });
            scoreInput.addEventListener('focus', updateScoreModalForKeyboard);
            scoreInput.addEventListener('blur', () => {
                const modal = document.getElementById('score-modal');
                modal.style.marginBottom = '';
            });
            document.getElementById('common-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (onInputConfirm) onInputConfirm();
                }
            });
            document.getElementById('input-confirm-btn').onclick = () => { if (onInputConfirm) onInputConfirm(); };
            document.getElementById('confirm-action-btn').onclick = () => { if (onActionConfirm) onActionConfirm(); };

            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', updateScoreModalForKeyboard);
                window.visualViewport.addEventListener('scroll', updateScoreModalForKeyboard);
            }
            window.addEventListener('resize', updateScoreModalForKeyboard);

            [
                ['score-modal-backdrop', 'score-modal'],
                ['task-modal-backdrop', 'task-modal'],
                ['data-modal-backdrop', 'data-modal'],
                ['input-modal-backdrop', 'input-modal'],
                ['confirm-modal-backdrop', 'confirm-modal'],
                ['stats-modal-backdrop', 'stats-modal']
            ].forEach(([backdropId, modalId]) => {
                const backdrop = document.getElementById(backdropId);
                if (!backdrop) return;
                backdrop.addEventListener('click', (e) => {
                    if (e.target === backdrop) closeModal(modalId);
                });
            });

            // 安卓返回键支持
            window.addEventListener('popstate', handleBackButton);

            // 初始化版本号显示
            document.getElementById('data-modal-version').textContent = APP_VERSION;

            // 显示版本号 Toast
            showVersionToast();
            setupVersionToastDismiss();
        }

        // 版本号 Toast 控制
        let versionToastTimer = null;
        let versionToastShown = false;

        function showVersionToast() {
            if (versionToastShown) return;
            versionToastShown = true;

            const toast = document.getElementById('toast');
            toast.textContent = '版本 v' + APP_VERSION;
            toast.classList.remove('opacity-0');

            // 3秒后自动消失
            versionToastTimer = setTimeout(() => {
                hideVersionToast();
            }, 3000);
        }

        function hideVersionToast() {
            const toast = document.getElementById('toast');
            toast.classList.add('opacity-0');
            if (versionToastTimer) {
                clearTimeout(versionToastTimer);
                versionToastTimer = null;
            }
        }

        // 用户操作时立即隐藏版本号 Toast
        function setupVersionToastDismiss() {
            const dismissEvents = ['click', 'touchstart', 'keydown', 'scroll', 'input'];

            dismissEvents.forEach(event => {
                document.addEventListener(event, function hideOnAction() {
                    hideVersionToast();
                    document.removeEventListener(event, hideOnAction);
                }, { once: true, passive: true });
            });
        }

        // 处理系统返回键
        function handleBackButton(e) {
            if (modalStack.length > 0) {
                const topModal = modalStack[modalStack.length - 1];
                closeModal(topModal);
            }
        }

        // 打开弹窗时压入栈
        function pushModal(modalId) {
            if (!modalStack.includes(modalId)) {
                modalStack.push(modalId);
                history.pushState({ modalId }, '');
            }
        }

        // 关闭弹窗时弹出栈
        function popModal(modalId) {
            const index = modalStack.indexOf(modalId);
            if (index > -1) {
                modalStack.splice(index, 1);
            }
        }

        // ================= 数据核心 =================
        function loadData() {
            const v2Data = StorageHelper.get(STORAGE_KEY_V2);
            if (v2Data && TypeValidator.validateAppState(v2Data)) {
                appState = v2Data;
                appState.tasks = appState.tasks.filter(TypeValidator.validateTask);
            } else {
                const initialTask = { id: Date.now(), title: "作业 1", records: {} };
                const v1Data = StorageHelper.get(STORAGE_KEY_V1);
                if (v1Data && TypeValidator.isArray(v1Data)) {
                    try {
                        v1Data.forEach(s => {
                            if (s && (s.submitted || s.score)) {
                                const id = parseInt(s.id);
                                if (TypeValidator.isValidId(id)) {
                                    initialTask.records[id] = { submitted: s.submitted, score: s.score };
                                }
                            }
                        });
                        initialTask.title = "导入的作业";
                        showToast("已迁移历史数据");
                    } catch (e) { console.error('Migration error:', e); }
                }
                appState.tasks = [initialTask];
                appState.currentTaskId = initialTask.id;
                saveAppStateNow();
            }
            if (!TypeValidator.isArray(appState.tasks) || appState.tasks.length === 0) {
                const t = { id: Date.now(), title: "作业 1", records: {} };
                appState.tasks = [t];
                appState.currentTaskId = t.id;
                saveAppStateNow();
            }
            if (!TypeValidator.isNumber(appState.currentTaskId)) {
                appState.currentTaskId = appState.tasks[0]?.id;
            }
            rebuildCurrentStudents();
        }

        // 原始保存函数
        function _saveAppStateRaw() {
            if (!TypeValidator.validateAppState(appState)) {
                console.error('Invalid app state, skipping save');
                return;
            }
            StorageHelper.set(STORAGE_KEY_V2, appState);
        }

        // 节流版本（用于频繁操作如点击学生）
        const saveAppState = throttle(_saveAppStateRaw, 500);

        // 强制立即保存（用于关键操作如切换任务）
        function saveAppStateNow() {
            _saveAppStateRaw();
        }

        function rebuildCurrentStudents() {
            const currentTask = appState.tasks.find(t => t.id === appState.currentTaskId) || appState.tasks[0];
            if (!currentTask || !currentTask.records) {
                currentTask.records = {};
            }
            const records = currentTask.records;
            currentStudents = [];
            for (let i = 1; i <= TOTAL_STUDENTS; i++) {
                const r = records[i] || { submitted: false, score: null };
                currentStudents.push({
                    id: i,
                    name: PLACEHOLDER_NAMES[i - 1] || `同学${i}`,
                    submitted: TypeValidator.isBoolean(r.submitted) ? r.submitted : false,
                    score: r.score !== undefined ? r.score : null
                });
            }
        }

        // ================= 模式切换逻辑 (新功能) =================
        function toggleClickMode() {
            isGradingMode = !isGradingMode;
            updateModeButtonState();
            showToast(isGradingMode ? "已切换至：点击评分" : "已切换至：点击登记");
        }

        function updateModeButtonState() {
            const btn = document.getElementById('btn-mode-toggle');
            const txt = document.getElementById('mode-text');
            const icon = btn.querySelector('i');

            if (isGradingMode) {
                // 激活状态 (评分)
                btn.className = "w-14 bg-blue-50 text-blue-600 border border-blue-200 rounded-xl font-medium active:bg-blue-100 flex flex-col items-center justify-center text-[10px] shadow-sm transition-colors duration-200";
                icon.className = "fa-solid fa-pen text-sm mb-0.5";
                txt.innerText = "评分";
            } else {
                // 默认状态 (登记)
                btn.className = "w-14 bg-white text-gray-600 border border-gray-300 rounded-xl font-medium active:bg-gray-50 flex flex-col items-center justify-center text-[10px] shadow-sm transition-colors duration-200";
                icon.className = "fa-solid fa-list-check text-sm mb-0.5";
                txt.innerText = "登记";
            }
        }

        // ================= 导入导出功能 =================
        function openSlideModal(backdropId, modalId) {
            const backdrop = document.getElementById(backdropId);
            const modal = document.getElementById(modalId);
            if (!backdrop || !modal || !backdrop.classList.contains('hidden')) return;
            backdrop.classList.remove('hidden');
            modal.classList.add('translate-y-full');
            modal.offsetHeight;
            modal.classList.remove('translate-y-full');
            pushModal(modalId);
        }

        function openDataModal() {
            openSlideModal('data-modal-backdrop', 'data-modal');
        }

        function openStatsModal() {
            openSlideModal('stats-modal-backdrop', 'stats-modal');

            // 初始化选择状态
            if (!window.statsSelectedTasks) {
                const totalTasks = appState.tasks.length;
                window.statsSelectedTasks = new Set();
                // 默认选中最近5个作业
                const startIdx = Math.max(0, totalTasks - 5);
                for (let i = startIdx; i < totalTasks; i++) {
                    window.statsSelectedTasks.add(i);
                }
            }

            // 重置视图状态
            resetStatsView();

            renderStatsTaskList();
            updateStatsSelectionCount();
        }

        function resetStatsView() {
            const selectionArea = document.getElementById('stats-selection-area');
            const selectedTasksBar = document.getElementById('stats-selected-tasks-bar');
            const statsContainer = document.getElementById('stats-container');
            const statsEmpty = document.getElementById('stats-empty');
            const subtitle = document.getElementById('stats-subtitle');

            selectionArea.classList.remove('hidden', 'h-0', 'overflow-hidden');
            selectionArea.classList.add('flex-[10]');
            selectedTasksBar.classList.add('hidden');
            statsContainer.classList.add('hidden');
            statsEmpty.classList.add('hidden');
            subtitle.textContent = '选择作业查看提交情况';
        }

        // 渲染作业选择列表
        function renderStatsTaskList(filter = 'all') {
            const container = document.getElementById('stats-task-list');
            if (!container) return;

            let tasksToRender = [];
            const totalTasks = appState.tasks.length;

            switch (filter) {
                case 'recent':
                    const startIdx = Math.max(0, totalTasks - 5);
                    for (let i = startIdx; i < totalTasks; i++) {
                        tasksToRender.push({ index: i, ...appState.tasks[i] });
                    }
                    break;
                case 'latest':
                    if (totalTasks > 0) {
                        tasksToRender.push({ index: totalTasks - 1, ...appState.tasks[totalTasks - 1] });
                    }
                    break;
                default:
                    tasksToRender = appState.tasks.map((task, idx) => ({ index: idx, ...task }));
            }

            if (tasksToRender.length === 0) {
                container.innerHTML = '<div class="text-center text-sm text-gray-400 py-4">暂无作业数据</div>';
                return;
            }

            const fragment = document.createDocumentFragment();
            tasksToRender.forEach(task => {
                const isSelected = window.statsSelectedTasks.has(task.index);
                const taskNum = task.index + 1;
                const submittedCount = Object.values(task.records || {}).filter(r => r && r.submitted).length;

                const label = document.createElement('label');
                label.className = `flex items-center gap-3 p-3 rounded-xl border cursor-pointer transition-all duration-200 select-none ${
                    isSelected
                        ? 'bg-blue-50 border-blue-300 shadow-sm'
                        : 'bg-white border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                }`;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 shrink-0';
                checkbox.checked = isSelected;
                checkbox.onchange = () => toggleTaskSelectionForStats(task.index);
                
                const numDiv = document.createElement('div');
                numDiv.className = 'w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center shrink-0 font-mono text-xs font-bold text-gray-500';
                numDiv.textContent = taskNum;
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'flex-1 min-w-0';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'text-sm font-medium text-gray-800 truncate';
                titleDiv.textContent = task.title;
                titleDiv.title = task.title;
                
                const countDiv = document.createElement('div');
                countDiv.className = 'text-xs text-gray-400 mt-0.5';
                countDiv.textContent = `${submittedCount}人已交`;
                
                infoDiv.appendChild(titleDiv);
                infoDiv.appendChild(countDiv);
                
                label.appendChild(checkbox);
                label.appendChild(numDiv);
                label.appendChild(infoDiv);
                
                fragment.appendChild(label);
            });
            
            container.innerHTML = '';
            container.appendChild(fragment);
        }

        // 切换单个作业选择
        function toggleTaskSelectionForStats(taskIndex) {
            if (window.statsSelectedTasks.has(taskIndex)) {
                window.statsSelectedTasks.delete(taskIndex);
            } else {
                window.statsSelectedTasks.add(taskIndex);
            }
            updateStatsSelectionCount();
        }

        // 全选作业
        function selectAllTasksForStats() {
            const filter = document.querySelector('#stats-modal .overflow-x-auto button.bg-blue-50')?.innerText?.trim();
            let tasksToSelect = [];

            if (filter === '最近5次') {
                const totalTasks = appState.tasks.length;
                const startIdx = Math.max(0, totalTasks - 5);
                for (let i = startIdx; i < totalTasks; i++) tasksToSelect.push(i);
            } else if (filter === '最新作业') {
                if (appState.tasks.length > 0) {
                    tasksToSelect.push(appState.tasks.length - 1);
                }
            } else {
                for (let i = 0; i < appState.tasks.length; i++) {
                    tasksToSelect.push(i);
                }
            }

            tasksToSelect.forEach(idx => window.statsSelectedTasks.add(idx));
            renderStatsTaskList();
            updateStatsSelectionCount();
        }

        // 清空选择
        function clearTaskSelectionForStats() {
            window.statsSelectedTasks.clear();
            renderStatsTaskList();
            updateStatsSelectionCount();
        }

        // 快捷筛选
        function quickFilterStats(type) {
            // 更新按钮状态
            const buttons = document.querySelectorAll('#stats-modal .overflow-x-auto button');
            buttons.forEach(btn => {
                btn.classList.remove('bg-blue-50', 'border-blue-300', 'text-blue-600');
                btn.classList.add('bg-white', 'border-gray-200', 'text-gray-600');
            });
            event.target.classList.remove('bg-white', 'border-gray-200', 'text-gray-600');
            event.target.classList.add('bg-blue-50', 'border-blue-300', 'text-blue-600');

            renderStatsTaskList(type);
            updateStatsSelectionCount();
        }

        // 更新选择计数
        function updateStatsSelectionCount() {
            const count = window.statsSelectedTasks ? window.statsSelectedTasks.size : 0;
            const total = appState.tasks.length;
            const counterEl = document.getElementById('stats-selection-count');
            if (counterEl) {
                counterEl.textContent = `已选 ${count} / ${total} 项作业`;
            }
        }

        function quickFilter(type) {
            const now = new Date();
            const startTask = document.getElementById('stats-start-task');
            const endTask = document.getElementById('stats-end-task');
            const startDate = document.getElementById('stats-start-date');
            const endDate = document.getElementById('stats-end-date');

            // 重置所有输入
            startTask.value = '';
            endTask.value = '';
            startDate.value = '';
            endDate.value = '';

            switch (type) {
                case 'all':
                    startTask.value = '1';
                    endTask.value = appState.tasks.length.toString();
                    break;

                case 'last-week':
                    const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    startDate.value = oneWeekAgo.toISOString().split('T')[0];
                    endDate.value = now.toISOString().split('T')[0];
                    break;

                case 'last-month':
                    const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    startDate.value = oneMonthAgo.toISOString().split('T')[0];
                    endDate.value = now.toISOString().split('T')[0];
                    break;

                case 'last-5':
                    const totalTasks = appState.tasks.length;
                    startTask.value = Math.max(1, totalTasks - 4).toString();
                    endTask.value = totalTasks.toString();
                    break;
            }

            // 自动生成统计
            setTimeout(() => generateStats(), 100);
        }

        function generateStats() {
            // 使用选中的作业
            const selectedIndices = Array.from(window.statsSelectedTasks || []).sort((a, b) => a - b);

            if (selectedIndices.length === 0) {
                showToast('请至少选择一项作业');
                return;
            }

            const filteredTasks = selectedIndices.map(idx => appState.tasks[idx]);

            // 计算统计结果
            const stats = calculateSubmissionStats(filteredTasks);
            displayStatsResults(stats, filteredTasks, selectedIndices);

            // 更新已选作业显示条
            updateSelectedTasksBar(filteredTasks, selectedIndices);

            // 收缩选择区域，显示统计结果
            collapseStatsSelection();

            // 切换视图
            document.getElementById('stats-empty').classList.add('hidden');
            document.getElementById('stats-container').classList.remove('hidden');
        }

        function collapseStatsSelection() {
            const selectionArea = document.getElementById('stats-selection-area');
            const selectedTasksBar = document.getElementById('stats-selected-tasks-bar');
            const subtitle = document.getElementById('stats-subtitle');

            selectionArea.classList.remove('flex-[10]');
            selectionArea.classList.add('h-0', 'overflow-hidden');

            selectedTasksBar.classList.remove('hidden');

            subtitle.textContent = '统计结果';
        }

        function expandStatsSelection() {
            const selectionArea = document.getElementById('stats-selection-area');
            const selectedTasksBar = document.getElementById('stats-selected-tasks-bar');
            const statsContainer = document.getElementById('stats-container');
            const statsEmpty = document.getElementById('stats-empty');
            const subtitle = document.getElementById('stats-subtitle');

            selectionArea.classList.remove('h-0', 'overflow-hidden');
            selectionArea.classList.add('flex-[10]');

            selectedTasksBar.classList.add('hidden');

            statsContainer.classList.add('hidden');
            statsEmpty.classList.add('hidden');

            subtitle.textContent = '选择作业查看提交情况';
        }

        function updateSelectedTasksBar(tasks, indices) {
            const container = document.getElementById('stats-selected-tasks-list');
            if (!container) return;

            // 只显示作业数量，不显示完整列表，节省空间
            container.innerHTML = `<span class="text-xs text-gray-600">共 ${tasks.length} 项作业</span>`;
        }

        function calculateSubmissionStats(tasks) {
            const studentStats = {};
            let totalSubmissions = 0;
            let totalTasks = tasks.length;
            let totalPossibleSubmissions = TOTAL_STUDENTS * totalTasks;

            // 初始化学生统计
            for (let i = 1; i <= TOTAL_STUDENTS; i++) {
                studentStats[i] = {
                    id: i,
                    name: PLACEHOLDER_NAMES[i - 1] || `同学${i}`,
                    submitted: 0,
                    totalTasks: totalTasks,
                    scores: []
                };
            }

            // 统计每个作业的提交情况
            tasks.forEach(task => {
                const records = task.records || {};
                Object.entries(records).forEach(([studentId, record]) => {
                    const sid = parseInt(studentId);
                    if (record.submitted && studentStats[sid]) {
                        studentStats[sid].submitted++;
                        totalSubmissions++;
                        if (record.score) {
                            studentStats[sid].scores.push(record.score);
                        }
                    }
                });
            });

            return {
                studentStats,
                totalSubmissions,
                totalTasks,
                totalPossibleSubmissions,
                completionRate: totalPossibleSubmissions > 0 ? (totalSubmissions / totalPossibleSubmissions) * 100 : 0
            };
        }

        function displayStatsResults(stats, tasks, selectedIndices) {
            const { studentStats, totalSubmissions, totalTasks, completionRate } = stats;

            // 1. 渲染仪表盘卡片
            const studentList = Object.values(studentStats);

            // 单次遍历计算分布（性能优化）
            const distribution = { excellent: 0, good: 0, average: 0, poor: 0 };
            for (const s of studentList) {
                const rate = s.submitted / s.totalTasks;
                if (rate >= 0.9) distribution.excellent++;
                else if (rate >= 0.7) distribution.good++;
                else if (rate >= 0.5) distribution.average++;
                else distribution.poor++;
            }

            const dashboardHtml = `
                <div class="flex gap-3 mb-4">
                    <div class="flex-1 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl p-4 text-white shadow-lg shadow-blue-500/20 relative overflow-hidden">
                        <i class="fa-solid fa-chart-line absolute -right-2 -bottom-2 text-6xl opacity-10"></i>
                        <div class="text-[10px] font-bold opacity-80 mb-1">班级完成率</div>
                        <div class="text-3xl font-black">${completionRate.toFixed(0)}<span class="text-sm font-normal ml-0.5 opacity-80">%</span></div>
                        <div class="w-full bg-white/20 h-1.5 rounded-full mt-2 overflow-hidden">
                            <div class="h-full bg-white rounded-full transition-all duration-500" style="width: ${completionRate}%"></div>
                        </div>
                    </div>
                    <div class="flex-1 bg-white border border-gray-100 rounded-2xl p-4 shadow-sm flex flex-col justify-center">
                        <div class="text-[10px] font-bold text-gray-400 mb-1">总提交</div>
                        <div class="text-2xl font-black text-gray-900">${totalSubmissions}</div>
                        <div class="text-[10px] text-gray-400 mt-0.5">${tasks.length}项作业</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-4 gap-2 mb-4">
                    <div class="bg-green-50 border border-green-100 rounded-xl p-3 text-center">
                        <div class="text-[10px] font-bold text-green-600">优秀</div>
                        <div class="text-lg font-black text-green-700 mt-0.5">${distribution.excellent}</div>
                    </div>
                    <div class="bg-blue-50 border border-blue-100 rounded-xl p-3 text-center">
                        <div class="text-[10px] font-bold text-blue-600">良好</div>
                        <div class="text-lg font-black text-blue-700 mt-0.5">${distribution.good}</div>
                    </div>
                    <div class="bg-orange-50 border border-orange-100 rounded-xl p-3 text-center">
                        <div class="text-[10px] font-bold text-orange-600">一般</div>
                        <div class="text-lg font-black text-orange-700 mt-0.5">${distribution.average}</div>
                    </div>
                    <div class="bg-red-50 border border-red-100 rounded-xl p-3 text-center">
                        <div class="text-[10px] font-bold text-red-600">待促</div>
                        <div class="text-lg font-black text-red-700 mt-0.5">${distribution.poor}</div>
                    </div>
                </div>
            `;
            document.getElementById('stats-dashboard').innerHTML = dashboardHtml;

            // 2. 存储数据用于后续搜索和排序
            window.currentStatsData = studentList.map(s => ({
                ...s,
                rate: (s.submitted / s.totalTasks) * 100
            }));

            // 3. 保存统计结果用于复制（必须在渲染前设置）
            const taskNumbers = selectedIndices.map(idx => idx + 1);
            const startTask = taskNumbers.length > 0 ? Math.min(...taskNumbers) : 0;
            const endTask = taskNumbers.length > 0 ? Math.max(...taskNumbers) : 0;
            const taskRangeText = taskNumbers.length > 0 
                ? (taskNumbers.length <= 3 
                    ? taskNumbers.map(n => `作业${n}`).join('、')
                    : `作业${startTask}-${endTask} (共${taskNumbers.length}项)`)
                : '无';

            window.currentStatsReport = {
                tasks: tasks.map((task, index) => ({
                    number: selectedIndices[index] + 1,
                    title: task.title,
                    submitted: Object.values(task.records || {}).filter(r => r.submitted).length
                })),
                studentList: studentList.map(s => ({ ...s, rate: (s.submitted / s.totalTasks) * 100 })),
                totalSubmissions,
                totalTasks,
                completionRate: completionRate.toFixed(1),
                startTask,
                endTask,
                taskRangeText,
                distribution
            };

            // 4. 执行一次初始排序并渲染列表
            sortStatsList();
        }

        function sortStatsList() {
            const sortMode = document.getElementById('stats-sort').value;
            const searchTerm = document.getElementById('stats-search').value.toLowerCase().trim();

            let filtered = [...window.currentStatsData];

            // 筛选
            if (searchTerm) {
                filtered = filtered.filter(s => {
                    const paddedId = s.id.toString().padStart(2, '0');
                    return s.name.toLowerCase().includes(searchTerm) ||
                        s.id.toString().includes(searchTerm) ||
                        paddedId.includes(searchTerm);
                });
            }

            // 排序
            switch (sortMode) {
                case 'rate-desc':
                    filtered.sort((a, b) => (b.rate - a.rate) || (a.id - b.id));
                    break;
                case 'rate-asc':
                    filtered.sort((a, b) => (a.rate - b.rate) || (a.id - b.id));
                    break;
                case 'id-asc':
                default:
                    filtered.sort((a, b) => a.id - b.id);
            }

            // 始终使用表格视图渲染
            renderStatsSheet(filtered);
        }

        function filterStatsList() {
            sortStatsList(); // 搜索其实是带过滤的排序
        }
        
        // 渲染表格视图
        function renderStatsSheet(list) {
            const listContainer = document.getElementById('stats-list');
            
            if (list.length === 0) {
                listContainer.innerHTML = `
                    <div class="py-12 text-center text-gray-400">
                        <i class="fa-solid fa-user-slash text-3xl mb-2 opacity-20"></i>
                        <p class="text-sm">未找到相关学生</p>
                    </div>
                `;
                return;
            }
            
            const currentReport = window.currentStatsReport;
            if (!currentReport) return;
            
            const tasks = currentReport.tasks;
            
            // 计算姓名列自适应宽度
            const maxNameLength = Math.max(...list.map(s => s.name.length), 2); // 至少2个字符
            const nameColumnWidth = Math.min(Math.max(maxNameLength * 18 + 20, 60), 180); // 每字符约18px，最小60px，最大180px
            
            // 构建表头
            let html = `
                <div class="overflow-x-auto hide-scrollbar -mx-4 px-4">
                    <table class="w-full bg-white border-collapse table-fixed">
                        <colgroup>
                            <col class="w-7">
                            <col style="width: ${nameColumnWidth}px; min-width: 50px;">
                            ${tasks.map(() => '<col class="w-7">').join('')}
                            <col class="w-14">
                            <col class="w-8">
                        </colgroup>
                        <thead class="bg-gray-100 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="px-1 py-2 text-left text-[10px] font-bold text-gray-400 uppercase tracking-wider bg-gray-100">#</th>
                                <th class="px-3 py-2 text-left text-xs font-bold text-gray-600 uppercase tracking-wider bg-gray-100">姓名</th>
            `;
            
            tasks.forEach((task, index) => {
                html += `
                    <th class="px-1 py-2 text-center text-[10px] font-bold text-gray-600 uppercase tracking-wider bg-gray-100">${task.number}</th>
                `;
            });
            
            html += `
                                <th class="px-3 py-2 text-right text-xs font-bold text-gray-600 uppercase tracking-wider bg-gray-100">提交率</th>
                                <th class="px-1 py-2 text-center text-[10px] font-bold text-gray-600 uppercase tracking-wider bg-gray-100"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
            `;
            
            // 构建表格内容
            list.forEach((student, idx) => {
                const rate = student.rate;
                const colorClass = rate >= 90 ? 'text-green-600 font-semibold' :
                    rate >= 70 ? 'text-blue-600 font-semibold' :
                        rate >= 50 ? 'text-orange-600 font-semibold' : 'text-red-500 font-semibold';
                
                // 计算未提交的作业序号和分数信息
                const missingTasks = [];
                const submissionStatus = [];
                const taskScores = [];
                tasks.forEach((task, index) => {
                    const taskIndex = task.number - 1;
                    const record = appState.tasks[taskIndex]?.records?.[student.id];
                    const isSubmitted = record?.submitted;
                    const score = record?.score || null;
                    submissionStatus.push(isSubmitted);
                    taskScores.push(score);
                    if (!isSubmitted) {
                        missingTasks.push(task.number);
                    }
                });
                
                const hasMissing = missingTasks.length > 0;
                const hasScores = taskScores.some(s => s !== null);
                const hasDetails = hasMissing || hasScores;
                const expandClass = 'hidden'; // 默认隐藏详情行
                
                html += `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-1 py-1.5 text-[10px] font-mono text-gray-500 truncate">${student.id}</td>
                        <td class="px-3 py-1.5 text-sm font-medium text-gray-800 truncate">${student.name}</td>
                `;
                
                tasks.forEach((task, index) => {
                    const isSubmitted = submissionStatus[index];
                    const score = taskScores[index];
                    
                    html += `
                        <td class="px-1 py-1.5 text-center">
                            <div class="w-4 h-4 mx-auto rounded-full flex items-center justify-center ${isSubmitted ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'}">
                                ${isSubmitted ? '<i class="fa-solid fa-check text-[10px]"></i>' : '<i class="fa-solid fa-minus text-[8px]"></i>'}
                            </div>
                        </td>
                    `;
                });
                
                html += `
                        <td class="px-3 py-1.5 text-xs text-right ${colorClass}">${rate.toFixed(0)}%</td>
                        <td class="px-1 py-1.5 text-center">
                            ${hasDetails ? `<button onclick="toggleRow(${student.id}, this)" class="w-5 h-5 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors">
                                <i class="fa-solid fa-chevron-down text-[10px] text-gray-500 transition-transform"></i>
                            </button>` : ''}
                        </td>
                    </tr>
                    <tr class="${expandClass} bg-gray-50/50" id="missing-${student.id}">
                        <td class="px-2 py-1.5 text-xs font-mono text-gray-400"></td>
                        <td class="px-3 py-1.5 text-xs text-gray-500">详情：</td>
                `;
                
                tasks.forEach((task, index) => {
                    const isSubmitted = submissionStatus[index];
                    const score = taskScores[index];
                    
                    if (isSubmitted && score !== null) {
                        html += `
                            <td class="px-1 py-1.5 text-center">
                                <span class="inline-block w-full max-w-[32px] text-center px-0.5 py-0.5 bg-blue-100 text-blue-600 rounded text-[10px] font-medium whitespace-nowrap overflow-hidden text-ellipsis">${score}</span>
                            </td>
                        `;
                    } else if (!isSubmitted) {
                        html += `
                            <td class="px-1 py-1.5 text-center"></td>
                        `;
                    } else {
                        html += `
                            <td class="px-1 py-1.5 text-center"></td>
                        `;
                    }
                });
                
                html += `
                        <td class="px-3 py-1.5"></td>
                        <td class="px-1 py-1.5"></td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            listContainer.innerHTML = html;
        }

        // 切换单行展开/收起
        function toggleRow(studentId, btn) {
            const missingRow = document.getElementById(`missing-${studentId}`);
            if (!missingRow) return;
            
            const isExpanded = !missingRow.classList.contains('hidden');
            
            if (isExpanded) {
                missingRow.classList.add('hidden');
                if (btn) {
                    btn.querySelector('i').classList.remove('rotate-180');
                }
            } else {
                missingRow.classList.remove('hidden');
                if (btn) {
                    btn.querySelector('i').classList.add('rotate-180');
                }
            }
        }

        // 一键展开/收起所有
        function toggleExpandAll() {
            const rows = document.querySelectorAll('#stats-list tbody tr');
            let hasExpanded = false;
            
            // 检查是否已有展开的行
            rows.forEach(row => {
                if (row.id.startsWith('missing-') && !row.classList.contains('hidden')) {
                    hasExpanded = true;
                }
            });
            
            rows.forEach(row => {
                if (row.id.startsWith('missing-')) {
                    const studentId = row.id.replace('missing-', '');
                    const prevRow = row.previousElementSibling;
                    const btn = prevRow?.querySelector('button');
                    
                    if (hasExpanded) {
                        row.classList.add('hidden');
                        if (btn) {
                            btn.querySelector('i').classList.remove('rotate-180');
                        }
                    } else {
                        row.classList.remove('hidden');
                        if (btn) {
                            btn.querySelector('i').classList.add('rotate-180');
                        }
                    }
                }
            });
            
            const btnText = document.getElementById('expand-btn-text');
            if (btnText) {
                btnText.textContent = hasExpanded ? '展开详情' : '收起详情';
            }
        }

        // 防抖版本供搜索输入使用
        const debouncedFilterStatsList = debounce(filterStatsList, 150);

        function copyStatsReport() {
            if (!window.currentStatsReport) {
                showToast('请先生成统计数据');
                return;
            }

            const report = window.currentStatsReport;
            let text = `【作业提交情况统计报告】\n`;
            text += `🗓 统计时间：${new Date().toLocaleString()}\n`;
            text += `📋 统计范围：${report.taskRangeText}\n`;
            text += `📊 总体情况：全班总提交${report.totalSubmissions}次，平均完成率${report.completionRate}%\n\n`;

            text += `👥 学生提交排行榜 (Top 10)：\n`;
            const topStudents = [...report.studentList]
                .sort((a, b) => b.rate - a.rate || a.id - b.id)
                .slice(0, 10);

            topStudents.forEach((s, i) => {
                text += `  ${i + 1}. ${s.name} (${s.id.toString().padStart(2, '0')}号): ${s.submitted}/${s.totalTasks} (${s.rate.toFixed(0)}%)\n`;
            });

            const lowStudents = report.studentList.filter(s => s.rate < 50);
            if (lowStudents.length > 0) {
                text += `\n⚠️ 需要关注 (完成率<50%)：\n`;
                lowStudents.forEach(s => {
                    text += `  - ${s.name}: ${s.submitted}/${s.totalTasks} (${s.rate.toFixed(0)}%)\n`;
                });
            }

            text += `\n💡 数据由“作业极速登记”自动生成`;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('统计报告已复制到剪贴板');
                }).catch(() => fallbackCopy(text));
            } else {
                fallbackCopy(text);
            }
        }


        function exportData() {
            const exportObj = {
                meta: {
                    appName: "HomeworkTracker",
                    version: "2.0",
                    exportedAt: new Date().toISOString(),
                    totalStudents: TOTAL_STUDENTS
                },
                readableSummary: {
                    students: PLACEHOLDER_NAMES.map((name, idx) => ({ id: idx + 1, name: name })),
                    tasks: appState.tasks.map(task => {
                        const submittedRecords = [];
                        Object.entries(task.records).forEach(([idStr, rec]) => {
                            if (rec.submitted || rec.score) {
                                const sid = parseInt(idStr);
                                submittedRecords.push({
                                    studentId: sid,
                                    studentName: PLACEHOLDER_NAMES[sid - 1],
                                    submitted: rec.submitted,
                                    score: rec.score
                                });
                            }
                        });
                        return {
                            id: task.id,
                            title: task.title,
                            stats: `${submittedRecords.length}/${TOTAL_STUDENTS}`,
                            records: submittedRecords
                        };
                    })
                },
                rawState: appState
            };
            const dataStr = JSON.stringify(exportObj, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `作业备份_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("已导出 JSON 文件");
            closeModal('data-modal');
        }

        function triggerImport() { document.getElementById('import-file-input').click(); }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const json = JSON.parse(e.target.result);
                    let newState = null;
                    if (json.rawState && Array.isArray(json.rawState.tasks)) newState = json.rawState;
                    else if (json.tasks && Array.isArray(json.tasks) && json.currentTaskId) newState = json;

                    if (newState) {
                        openConfirmModal("恢复备份", "导入将<b>覆盖</b>当前所有数据。<br>确定要继续吗？", () => {
                            appState = newState;
                            saveAppState();
                            loadData();
                            renderGrid();
                            updateStats();
                            updateHeaderTitle();
                            closeModal('confirm-modal');
                            closeModal('data-modal');
                            showToast("数据已成功恢复");
                        });
                    } else alert("文件格式不正确，无法识别。");
                } catch (err) { console.error(err); alert("文件解析失败，请检查文件是否损坏。"); }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function openResetModal(type) {
            closeModal('data-modal');
            setTimeout(() => {
                if (type === 'current') {
                    const task = appState.tasks.find(t => t.id === appState.currentTaskId);
                    const name = task ? task.title : "当前作业";
                    openConfirmModal("清空作业", `确定清空 <span class="font-bold text-black">${name}</span> 的所有记录吗？`, () => {
                        if (task) {
                            task.records = {};
                            saveAppState();
                            rebuildCurrentStudents();
                            renderGrid();
                            updateStats();
                            showToast("已清空当前作业");
                        }
                        closeModal('confirm-modal');
                    });
                } else if (type === 'all') {
                    openConfirmModal("重置所有", `确定要<span class="text-red-500 font-bold">删除所有作业和记录</span>吗？<br>此操作将使应用恢复出厂设置。`, () => {
                        localStorage.removeItem(STORAGE_KEY_V2);
                        localStorage.removeItem(STORAGE_KEY_V1);
                        location.reload();
                    });
                }
            }, 300);
        }

        // ================= 任务逻辑 =================
        function triggerCreateTask() {
            openInputModal("新建作业", `作业 ${appState.tasks.length + 1}`, (val) => {
                if (!val.trim()) return;
                const newTask = { id: Date.now(), title: val.trim(), records: {} };
                appState.tasks.push(newTask);
                switchTask(newTask.id);
                closeModal('input-modal');
                closeModal('task-modal');
                showToast(`已创建 "${val}"`);
            });
        }

        function switchTask(id) {
            if (appState.currentTaskId === id) return;
            appState.currentTaskId = id;
            saveAppStateNow();
            rebuildCurrentStudents();
            renderGrid();
            updateStats();
            updateHeaderTitle();
            closeModal('task-modal');
        }

        function triggerRenameTask(taskId) {
            const task = appState.tasks.find(t => t.id === taskId);
            if (!task) return;
            openInputModal("重命名", task.title, (val) => {
                if (!val.trim()) return;
                task.title = val.trim();
                saveAppStateNow();
                updateHeaderTitle();
                openTaskModal();
                closeModal('input-modal');
            });
        }

        function triggerDeleteTask(taskId) {
            openConfirmModal("删除", "确定删除此作业吗？", () => {
                const idx = appState.tasks.findIndex(t => t.id === taskId);
                if (idx > -1) {
                    appState.tasks.splice(idx, 1);
                    if (appState.currentTaskId === taskId) appState.currentTaskId = appState.tasks[0]?.id;
                    saveAppStateNow();
                    rebuildCurrentStudents();
                    renderGrid();
                    updateStats();
                    updateHeaderTitle();
                    if (appState.tasks.length === 0) closeModal('task-modal'); else openTaskModal();
                }
                closeModal('confirm-modal');
            });
        }

        function updateStudent(index, submitted, score) {
            const studentId = index + 1;
            const task = appState.tasks.find(t => t.id === appState.currentTaskId);
            if (!task.records[studentId]) task.records[studentId] = {};
            task.records[studentId].submitted = submitted;
            task.records[studentId].score = score;
            if (!submitted && (score === null || score === '')) delete task.records[studentId];
            saveAppState();
            currentStudents[index].submitted = submitted;
            currentStudents[index].score = score;
        }

        function toggleStatus(id) {
            const idx = id - 1;
            updateStudent(idx, !currentStudents[idx].submitted, currentStudents[idx].score);
            renderOne(idx);
            updateStats();
        }

        function setScoreAndClose(score) {
            if (currentEditingId === null) return;
            const idx = currentEditingId - 1;
            updateStudent(idx, (score !== null && score !== '') ? true : currentStudents[idx].submitted, score);
            renderOne(idx);
            updateStats();
            closeModal('score-modal');
        }

        function renderGrid() {
            const grid = document.getElementById('student-grid');
            grid.classList.add('opacity-0');
            requestAnimationFrame(() => {
                const fragment = document.createDocumentFragment();
                currentStudents.forEach((s, i) => {
                    const el = document.createElement('div');
                    renderCellContent(el, s);
                    bindTouchEvents(el, s.id);
                    fragment.appendChild(el);
                });
                grid.innerHTML = '';
                grid.appendChild(fragment);
                requestAnimationFrame(() => {
                    grid.classList.remove('opacity-0');
                });
            });
        }

        function renderOne(idx) {
            const grid = document.getElementById('student-grid');
            if (grid.children[idx]) renderCellContent(grid.children[idx], currentStudents[idx]);
        }

        function renderCellContent(el, s) {
            const isSub = s.submitted;
            const hasScore = s.score !== null && s.score !== '';
            el.className = `student-btn relative aspect-square rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all duration-200 select-none ${isSub ? 'status-submitted' : 'status-default'}`;
            let html = '';
            if (isNameVisible) {
                html += `<span class="absolute top-1 left-1 text-[10px] font-bold ${isSub ? 'text-green-100' : 'text-gray-400'}">${s.id}</span>`;
                html += `<span class="text-sm font-bold leading-tight ${isSub ? 'opacity-100' : 'opacity-80'}">${s.name.slice(-2)}</span>`;
            } else {
                html += `<span class="text-xl font-bold ${isSub ? 'opacity-100' : 'opacity-80'}">${s.id}</span>`;
            }
            if (hasScore) html += `<span class="absolute top-1 right-1 text-[10px] font-bold ${isSub ? 'bg-white/20' : 'bg-gray-400/20 text-gray-500'} px-1 rounded text-white border border-white/20">${s.score}</span>`;
            el.innerHTML = html;
        }

        // [修改] 触控核心逻辑 (支持模式判断)
        function bindTouchEvents(el, id) {
            let timer, startX, startY, isScroll = false, isLong = false;

            // 禁止安卓浏览器长按弹出菜单
            el.oncontextmenu = (e) => { e.preventDefault(); e.stopPropagation(); return false; };

            const start = (x, y) => {
                startX = x; startY = y; isScroll = false; isLong = false;
                timer = setTimeout(() => {
                    if (!isScroll) {
                        isLong = true;
                        if (navigator.vibrate) navigator.vibrate(50);
                        openScoreModal(id); // 长按始终打开评分
                    }
                }, 500);
            };

            const move = (x, y) => {
                if (Math.abs(x - startX) > 10 || Math.abs(y - startY) > 10) {
                    isScroll = true; clearTimeout(timer);
                }
            };

            const end = () => {
                clearTimeout(timer);
                if (!isScroll && !isLong) {
                    // [核心逻辑修改] 根据当前模式决定短按行为
                    if (isGradingMode) {
                        openScoreModal(id); // 评分模式：单击打开评分
                    } else {
                        toggleStatus(id);   // 登记模式：单击切换状态
                    }
                }
            };

            el.ontouchstart = e => start(e.touches[0].clientX, e.touches[0].clientY);
            el.ontouchmove = e => move(e.touches[0].clientX, e.touches[0].clientY);
            el.ontouchend = e => { if (e.cancelable) e.preventDefault(); end(); };
            el.onmousedown = e => start(e.clientX, e.clientY);
            el.onmousemove = e => { if (e.buttons === 1) move(e.clientX, e.clientY); };
            el.onmouseup = end;
            el.onmouseleave = () => clearTimeout(timer);
        }

        // 辅助 UI 函数
        function openTaskModal() {
            const list = document.getElementById('task-list');
            const fragment = document.createDocumentFragment();
            
            appState.tasks.forEach(task => {
                const isSel = task.id === appState.currentTaskId;
                const count = Object.values(task.records || {}).filter(r => r && r.submitted).length;
                const div = document.createElement('div');
                div.className = `task-item flex items-center justify-between p-3 rounded-xl cursor-pointer ${isSel ? 'bg-blue-50 border border-blue-100' : 'bg-white border border-transparent'}`;
                div.onclick = () => switchTask(task.id);

                const infoDiv = document.createElement('div');
                infoDiv.className = "flex-1 min-w-0 pr-2";

                const titleRow = document.createElement('div');
                titleRow.className = "flex items-center gap-2";

                const titleSpan = document.createElement('span');
                titleSpan.className = `font-bold truncate block max-w-full ${isSel ? 'text-blue-600' : 'text-gray-700'}`;
                titleSpan.textContent = task.title;

                titleRow.appendChild(titleSpan);
                if (isSel) {
                    const icon = document.createElement('i');
                    icon.className = "fa-solid fa-check-circle text-blue-500 text-xs shrink-0";
                    titleRow.appendChild(icon);
                }

                const subText = document.createElement('div');
                subText.className = "text-xs text-gray-400 mt-0.5";
                subText.textContent = `已提交: ${count}/${TOTAL_STUDENTS}`;

                infoDiv.appendChild(titleRow);
                infoDiv.appendChild(subText);
                div.appendChild(infoDiv);

                const actions = document.createElement('div');
                actions.className = "flex items-center gap-1 shrink-0";

                const btnEdit = document.createElement('button');
                btnEdit.className = "p-2 text-gray-400 hover:text-blue-500 w-8 h-8 flex items-center justify-center rounded-full active:bg-blue-50";
                btnEdit.innerHTML = '<i class="fa-solid fa-pen text-sm"></i>';
                btnEdit.onclick = (e) => { e.stopPropagation(); triggerRenameTask(task.id); };
                actions.appendChild(btnEdit);

                if (appState.tasks.length > 1) {
                    const btnDel = document.createElement('button');
                    btnDel.className = "p-2 text-gray-400 hover:text-red-500 w-8 h-8 flex items-center justify-center rounded-full active:bg-red-50";
                    btnDel.innerHTML = '<i class="fa-regular fa-trash-can text-sm"></i>';
                    btnDel.onclick = (e) => { e.stopPropagation(); triggerDeleteTask(task.id); };
                    actions.appendChild(btnDel);
                }
                div.appendChild(actions);
                fragment.appendChild(div);
            });
            
            list.innerHTML = '';
            list.appendChild(fragment);
            
            const backdrop = document.getElementById('task-modal-backdrop');
            const modal = document.getElementById('task-modal');
            backdrop.classList.remove('hidden');
            requestAnimationFrame(() => modal.classList.remove('translate-y-full'));
            pushModal('task-modal');
        }

        function openInputModal(title, val, cb) {
            document.getElementById('input-modal-title').innerText = title;
            const input = document.getElementById('common-input');
            input.value = val;
            onInputConfirm = () => cb(input.value);
            const bg = document.getElementById('input-modal-backdrop');
            const m = document.getElementById('input-modal');
            bg.classList.remove('hidden');
            requestAnimationFrame(() => { m.classList.remove('scale-95', 'opacity-0'); m.classList.add('scale-100', 'opacity-100'); });
            setTimeout(() => { input.focus(); input.select(); }, 100);
            pushModal('input-modal');
        }

        function openConfirmModal(title, msg, cb) {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerHTML = msg;
            onActionConfirm = cb;
            const bg = document.getElementById('confirm-modal-backdrop');
            const m = document.getElementById('confirm-modal');
            bg.classList.remove('hidden');
            requestAnimationFrame(() => { m.classList.remove('scale-95', 'opacity-0'); m.classList.add('scale-100', 'opacity-100'); });
            pushModal('confirm-modal');
        }

        function closeModal(id) {
            const bg = document.getElementById(`${id}-backdrop`);
            const m = document.getElementById(id);
            if (id.includes('task') || id.includes('data') || id.includes('stats')) m.classList.add('translate-y-full');
            else { m.classList.remove('scale-100', 'opacity-100'); m.classList.add('scale-95', 'opacity-0'); }
            if (id === 'input-modal') document.getElementById('common-input').blur();
            if (id === 'score-modal') {
                document.getElementById('custom-score-input').blur();
                document.getElementById('score-modal').style.marginBottom = '';
                currentEditingId = null;
            }
            popModal(id);
            setTimeout(() => bg.classList.add('hidden'), 200);
        }

        function saveCustomScore() {
            const val = document.getElementById('custom-score-input').value.trim();
            setScoreAndClose(val === '' ? null : val);
        }

        function invertSelection() {
            currentStudents.forEach((s, idx) => {
                updateStudent(idx, !s.submitted, s.score);
            });
            renderGrid();
            updateStats();
            showToast("已反选所有状态");
        }

        function toggleNameDisplay() {
            isNameVisible = !isNameVisible;
            StorageHelper.set(NAME_VISIBILITY_KEY, isNameVisible);
            updateNameButtonState();
            renderGrid();
        }

        function updateNameButtonState() {
            const btn = document.getElementById('btn-toggle-name');
            if (isNameVisible) {
                btn.classList.add('bg-blue-50', 'text-blue-600', 'border-blue-200');
                btn.classList.remove('bg-white', 'text-gray-600', 'border-gray-300');
            } else {
                btn.classList.remove('bg-blue-50', 'text-blue-600', 'border-blue-200');
                btn.classList.add('bg-white', 'text-gray-600', 'border-gray-300');
            }
        }

        function toggleFooterOnly() {
            isFooterHidden = !isFooterHidden;
            const f = document.getElementById('app-footer');
            const b = document.getElementById('immersive-btn');
            const g = document.getElementById('student-grid');
            if (isFooterHidden) {
                f.classList.add('hidden');
                b.classList.replace('bottom-28', 'bottom-4');
                b.querySelector('i').classList.replace('fa-expand', 'fa-compress');
                g.classList.replace('pb-24', 'pb-4');
                showToast("已隐藏底栏");
            } else {
                f.classList.remove('hidden');
                b.classList.replace('bottom-4', 'bottom-28');
                b.querySelector('i').classList.replace('fa-compress', 'fa-expand');
                g.classList.replace('pb-4', 'pb-24');
            }
        }

        function toggleStatsImmersive() {
            if (!window.isStatsImmersive) window.isStatsImmersive = false;
            window.isStatsImmersive = !window.isStatsImmersive;
            const h = document.getElementById('stats-modal-header');
            const f = document.getElementById('stats-modal-footer');
            const b = document.getElementById('stats-immersive-btn');
            const c = document.getElementById('stats-container');
            if (window.isStatsImmersive) {
                h.classList.add('hidden');
                f.classList.add('hidden');
                b.classList.replace('top-2', 'top-1');
                b.querySelector('i').classList.replace('fa-compress', 'fa-expand');
                c.classList.replace('pt-4', 'pt-1');
            } else {
                h.classList.remove('hidden');
                f.classList.remove('hidden');
                b.classList.replace('top-1', 'top-2');
                b.querySelector('i').classList.replace('fa-expand', 'fa-compress');
                c.classList.replace('pt-1', 'pt-4');
            }
        }

        function updateStats() {
            const count = currentStudents.filter(s => s.submitted).length;
            const pct = Math.round((count / TOTAL_STUDENTS) * 100);
            document.getElementById('count-display').innerText = `${count}/${TOTAL_STUDENTS}`;
            document.getElementById('progress-bar').style.width = `${pct}%`;
        }

        function updateHeaderTitle() {
            const t = appState.tasks.find(t => t.id === appState.currentTaskId);
            document.getElementById('current-task-title').innerText = t ? t.title : "作业";
        }

        function copyMissingReport() {
            const missing = currentStudents.filter(s => !s.submitted);
            const count = currentStudents.length - missing.length;
            const taskTitle = appState.tasks.find(t => t.id === appState.currentTaskId)?.title || "作业";
            let text = `【${taskTitle} 反馈】\n🗓 日期：${new Date().toLocaleDateString()}\n✅ 已交：${count}人\n`;
            if (!missing.length) text += `🎉 全员已交！`;
            else {
                text += `❌ 未交 (${missing.length}人)：\n`;
                text += missing.map(s => isNameVisible ? `${s.id}${s.name}` : s.id).join(', ');
                text += `\n请相关同学尽快提交！`;
            }
            if (navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(text).then(() => showToast('已复制')).catch(() => fallbackCopy(text));
            else fallbackCopy(text);
        }

        function fallbackCopy(text) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            try { document.execCommand('copy'); showToast('已复制'); } catch (e) { }
            document.body.removeChild(el);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('opacity-0');
            requestAnimationFrame(() => {
                setTimeout(() => t.classList.add('opacity-0'), 2000);
            });
        }

        function openScoreModal(id) {
            currentEditingId = id;
            const s = currentStudents[id - 1];
            document.getElementById('modal-student-id').innerText = String(id).padStart(2, '0');
            document.getElementById('modal-student-name').innerText = s.name;
            const input = document.getElementById('custom-score-input');
            input.value = s.score || '';

            const backdrop = document.getElementById('score-modal-backdrop');
            const modal = document.getElementById('score-modal');
            backdrop.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.remove('scale-95', 'opacity-0');
                modal.classList.add('scale-100', 'opacity-100');
            });
            setTimeout(() => {
                input.focus();
                input.select();
                updateScoreModalForKeyboard();
            }, 50);
            pushModal('score-modal');
        }

        // Start
        init();
    </script>
</body>

</html>
